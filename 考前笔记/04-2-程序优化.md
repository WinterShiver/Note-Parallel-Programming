## CH 5-2 系统优化

### 基本概念
级别：系统-应用-算法-函数-循环-语句-指令


### 系统
* 找瓶颈：处理器，处理器负载均衡，内存，内存带宽，网速

### 应用
* 编译选项
* 高性能库
* 全局变量：不在更低一级环境使用高级成员
* 指针：指针是最高级的成员了，改进：动态，如int temp
* 重名但不同

### 算法
* Cache利用：局部性
  * 例子：如果逻辑上非不在一起，要保证在一个块里
* 查表

### 函数
函数调用时，参数从reg或stack获得，并将返回结果入栈，要改善这个环节带来的问题
* 尽量把东西放reg里
* 传指针：防止传太大的东西进来，复制，移动，销毁慢
* 不使用高级成员
* inline

### 循环
* 合并
  * 好处：减少判断次数，增加指令级优化能力（因为无相关）
* 展开
  * 做法：完全展开小循环or大循环内好几次循环体，降低次数
  * 标准:reg够用，内部判断不影响
  * 注意：处理末尾数据
  * 一般不手动展开，有编译器呢
* 累积
  * 做法：在展开的基础上减少reg使用
  * 循环次数不但降下来了，循环体里面用的资源也少了
* 拆分
  * 目的：减少reg使用
  * 原则：不要增加访存，计算
* 去除循环依赖
  * 类型
    * 内部，间
    * 数据依赖：RAW，WAR，WAW
    * 控制依赖：
  * 思路
    * 尽量用reg（但不超限）
    * 用低级别成员（临时变量）
    * 调序
  * 解法
    * 重命名（数据依赖）
      * 缺点：内存分配，拷贝，内存释放开销
    * 临时变量，条件转移（控制依赖）

### 语句
* 生成更好更高效的指令
  * 减少内存读写，使用小的DS，结构体对齐，表达式移除，分支优化，优化交换性能
  * 常见的分支优化方法（防止预测失败）：避免if in for，拆分循环，合并if，计算代预测，条件赋值，查表代预测

### 指令
减少数据依赖+多发射
优化*/%
具体化

### OpenMP的优化
* 思路
  * Cache命中率，并行中的冗余串行，创建成本，负载均衡，同步开销
* EPCC基本测试
* 具体
  * 减少同步（nowait+barrier）
  * 减少并行区数量（parallel+for）
  * 小critical
